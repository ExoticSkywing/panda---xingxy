# 前台商品发布补充增强功能

## 1. 概述
在原有的前台商品发布功能基础上，增加推广返佣设置模块，并全面优化 PC 及移动端下的底部操作栏、状态提示与保存逻辑。

## 2. 核心功能及优化细节

### 2.1 推广返佣体系对接
- **模块插入**：在"发货设置"区下新增"推广返佣"模块。
- **选择模式**：支持 4 种模式：默认（跟随系统/分类）、不参与、按比例返佣、固定金额返佣。
- **动态显隐**：基于 jQuery 事件，选中比例/金额时自动展开下级选项。
- **数值限制**：JS/PHP 均进行了数值钳位保护（如比例限制为 0-100，金额必定非负）。
- **完全兼容 Zibll/CSF**：提取和保存使用的键名（`type`, `all_ratio`, `vip_1_fixed` 等）与原版后台框架完全等价。

### 2.2 底部固定操作栏 (Sticky Bar)
- **视觉优化**：移除多余的侧边栏按钮和状态提示，统一放置于屏幕底部，保持 `position: sticky` 永远悬浮。
- **状态感知引导文案**：根据当前商品状态（已发布/待审核/草稿/新商品）提供通俗易懂的提示。
  - "已发布 · 修改后点保存生效（卡密导入除外）"
  - "审核中 · 请等待管理员通过"
- **移动端适配**：移动端采用 `flex-direction: column` 上下两行布局，文案缩减字号并居中，防止按钮被挤压换行（保存体验友好）。

### 2.3 核心保存与状态逻辑修复
- **已发布商品免审核**：此前已发布的商品如果商家修改了标题/内容点击保存，由于原有逻辑直接拉回 `pending`（待审核）导致已上架商品意外下架。现已完善为：
  - 管理员操作：直接 `publish`。
  - **已发布商品**原作者编辑保存：保持 `publish`（直接生效），不跳页。
  - 新增商品/草稿提交：进入 `pending` 待审状态并跳转首页。
- **AJAX 表单补充**：完善 `action-newproduct.php` 和 jQuery `$.ajax` 表单采集，补充了之前缺失的 7 个 `rebate` 字段。

### 2.4 其他 UX 与样式细节修复
- **卡密导入提示**：在卡密导入按钮旁增加"导入后立即生效，无需另外保存"说明。
- **按钮 Loading 覆盖 Bug 修复**：废弃 Zibll 自带且遮挡文字的 `.loading` class，改为自定义注入 `<i class="fa fa-spinner fa-spin"></i>保存中...` 防止文案转圈。
- **预览功能**：底部操作栏对已存在的商品新增了【预览商品】按钮，点击新标签页打开。
- **高度对齐**：右侧侧边栏组件变多后，左侧 TinyMCE 默认为 400px，下方空隙变大。已将编辑器默认行和高度拉升，减小了不对称留白。

## 3. 受影响文件

| 文件路径 | 修改类型 | 说明 |
|----------|---------|------|
| `pages/newproduct.php` | `M` | 新增返佣组件 HTML/JS，添加 Sticky Bar，调整整体高度与列边距。 |
| `inc/action-newproduct.php` | `M` | 补充 rebate 数据字段的校验存入逻辑，修正 publish 覆写状态跳转行为。 |

## 4. 后续维护
目前发布页表单项已完全闭环商品基础要素与变现组件（积分/卡密/发货/返佣），如需再增补分类项或虚拟资产项请沿用当前 AJAX 模式。
